name: Test Extension

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-extension:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install web-ext
      run: npm install -g web-ext
        
    - name: âœ… Test 1: Firefox Build
      run: |
        echo "ğŸ¦Š Testing if Firefox extension builds..."
        web-ext build --source-dir=src --artifacts-dir=test-artifacts --overwrite-dest
        
        if [ -f test-artifacts/*.zip ]; then
          echo "âœ… Firefox XPI builds successfully"
        else
          echo "âŒ Firefox build failed"
          exit 1
        fi
        
    - name: âœ… Test 2: Chrome Compatibility
      run: |
        echo "ğŸŒ Testing Chrome compatibility..."
        
        # Create Chrome version (remove Firefox-specific fields)
        mkdir -p chrome-test
        cp -r src/* chrome-test/
        
        node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('chrome-test/manifest.json'));
          delete manifest.browser_specific_settings;
          fs.writeFileSync('chrome-test/manifest.json', JSON.stringify(manifest, null, 2));
        "
        
        # Test if Chrome ZIP can be created
        cd chrome-test && zip -r ../chrome-test.zip . && cd ..
        
        if [ -f chrome-test.zip ]; then
          echo "âœ… Chrome extension packages successfully"
        else
          echo "âŒ Chrome packaging failed"
          exit 1
        fi
        
    - name: âœ… Test 3: Required Files Exist
      run: |
        echo "ğŸ“ Checking required files exist..."
        
        required_files=(
          "src/manifest.json"
          "src/popup/popup.html"
          "src/popup/popup.js"
          "src/options/options.html"
          "src/options/options.js"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done
        
        echo "âœ… All required files present"
        
    - name: âœ… Test 4: JavaScript Syntax
      run: |
        echo "ğŸ” Checking JavaScript syntax..."
        
        # Simple syntax check with Node.js
        for file in src/popup/popup.js src/options/options.js; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            node -c "$file" || exit 1
          fi
        done
        
        echo "âœ… JavaScript syntax is valid"
        
    - name: Summary
      run: |
        echo "ğŸ‰ All tests passed!"
        echo "âœ… Firefox builds"
        echo "âœ… Chrome compatible" 
        echo "âœ… Required files exist"
        echo "âœ… JavaScript syntax valid"